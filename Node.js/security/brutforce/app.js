const express = require('express');
const rateLimit = require('express-rate-limit');

const app = express();

// === Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¹Ñ‚-Ð»Ð¸Ð¼Ð¸Ñ‚ Ð´Ð»Ñ Ð²ÑÐµÑ… /api/* Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð² ===
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 Ð¼Ð¸Ð½ÑƒÑ‚
  max: 100,
  message: {
    status: 'error',
    message: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ'
  },
  statusCode: 429
});
app.use('/api/', apiLimiter);

// === ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¹Ñ‚-Ð»Ð¸Ð¼Ð¸Ñ‚ Ð´Ð»Ñ /api/login ===
const loginLimiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 Ð¼Ð¸Ð½ÑƒÑ‚Ð°
  max: 5,
  message: {
    status: 'error',
    message: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð²Ñ…Ð¾Ð´Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.'
  },
  statusCode: 429
});

// === ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ API ===
// POST /api/register
app.get('/api/register', (req, res) => {
  res.status(201).json({ status: 'success', message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½' });
});

// POST /api/login â€” Ñ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼ Ñ€ÐµÐ¹Ñ‚-Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð¼
app.get('/api/login', loginLimiter, (req, res) => {
  // Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð²Ð°ÑˆÐ° Ð»Ð¾Ð³Ð¸ÐºÐ° Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
  res.json({ status: 'success', message: 'Ð’Ñ…Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾' });
});

// GET /api/data
app.get('/api/data', (req, res) => {
  res.json({ data: 'ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· API' });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½ÐµÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
app.use((req, res) => {
  res.status(404).json({ status: 'error', message: 'ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:${PORT}`);
});